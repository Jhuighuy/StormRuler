# Copyright (C) 2020-2023 Oleg Butakov
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to
# deal in the Software without restriction, including without limitation the
# rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
# sell copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in
# all copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
# FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
# IN THE SOFTWARE.

# ------------------------------------------------------------------------------

name: Coverity

# ------------------------------------------------------------------------------

# Temporarily, later -- on schedule.
on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

# ------------------------------------------------------------------------------

jobs:
  coverity:
    name: Build
    runs-on: windows-latest
    env:
      # Directory where build-wrapper output will be placed.
      CONV_BUILD_OUT_DIR: "cov_build_out_dir"

    steps:

      # ------------------------------------------------------------------------

      - name: Checkout
        uses: actions/checkout@v3

      # ------------------------------------------------------------------------

      - name: Install coverity-build-tool
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COVERITY_TOKEN: ${{ secrets.COVERITY_TOKEN }}
        shell: bash
        run: |
          # Download the archieve.
          curl \
              "https://scan.coverity.com/download/win64" \
              --data "token=${{ env.COVERITY_TOKEN }}&project=Jhuighuy%2FStormRuler" \
              --output ../cov-analysis-win64.zip
          # Unzip it.
          7z x \
              "../cov-analysis-win64.zip" \
              "-o../cov-analysis-win64"

      # ------------------------------------------------------------------------

      - name: Run coverity-build-tool
        shell: bash
        run: |
          export PATH="../cov-analysis-win64/cov-analysis-win64-2022.6.0/bin:$PATH"
          ./scripts/configure.py -std=c++20 -cfg=Debug
          cov-configure --msvc
          cov-build \
              --dir ${{ env.CONV_BUILD_OUT_DIR }} \
              python3 ./scripts/build.py -j

      # ------------------------------------------------------------------------

      - name: Upload results
        uses: actions/upload-artifact@v3
        with:
          name: cov-int
          path: cov-int/

# ------------------------------------------------------------------------------
